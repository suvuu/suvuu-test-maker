<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TestMaker - Available Tests</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
  <div class="container py-5">
    <h2 class="mb-4">TestMaker</h2>

    <div class="mb-4 d-flex flex-wrap gap-2 align-items-center">
      <a href="/new" class="btn btn-success">New Test</a>
      <a href="/export" class="btn btn-info">Export All Tests (data.json)</a>

      <button type="button" class="btn btn-secondary" id="import-btn">Import Tests</button>
      <form id="import-form" method="post" enctype="multipart/form-data" action="/import" style="display: none;">
        <input type="file" name="file" accept=".json" id="import-file-input">
      </form>

      <div id="import-status" class="text-light ms-3"></div>
    </div>

    {% if tests %}
    <ul class="list-group">
      {% for test in tests %}
      <li class="list-group-item bg-secondary text-light d-flex justify-content-between align-items-center mb-2">
        <div><strong>{{ test.title }}</strong> ({{ test.questions|length }} questions)</div>
        <div>
          <a href="/take/{{ loop.index0 }}" class="btn btn-sm btn-primary me-2">Take</a>
          <a href="/edit/{{ loop.index0 }}" class="btn btn-sm btn-warning me-2">Edit</a>
          <button class="btn btn-sm btn-danger delete-btn" data-index="{{ loop.index0 }}" data-title="{{ test.title }}">Delete</button>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No tests available. Create one or import a backup!</p>
    {% endif %}
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Delete test: <strong id="testTitlePreview"></strong>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Yes, Delete</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Delete confirmation
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const title = btn.dataset.title;
        const index = btn.dataset.index;
        document.getElementById('testTitlePreview').textContent = title;
        document.getElementById('confirmDeleteBtn').href = `/delete/${index}`;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
      });
    });

    // Import functionality
    document.getElementById('import-btn').addEventListener('click', () => {
      document.getElementById('import-file-input').click();
    });

    document.getElementById('import-file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.name.endsWith('.json')) {
        alert("Please select a .json file");
        return;
      }

      const status = document.getElementById('import-status');
      status.innerHTML = '<span class="text-info">Uploading...</span>';

      const formData = new FormData();
      formData.append('file', file);

      fetch('/import', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
            status.innerHTML = `<span class="text-success">Success: ${data.message}</span>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            status.innerHTML = `<span class="text-danger">Failed: ${data.error}</span>`;
        }
      })
      .catch(() => {
        status.innerHTML = '<span class="text-danger">Failed: Upload failed</span>';
      });
    });
  </script>
</body>
</html>